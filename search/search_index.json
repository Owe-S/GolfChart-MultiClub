{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"GolfChart Dokumentasjon","text":"<p>Velkommen til GolfChart \u2014 et moderne, multi-klubb golfbilstyringssystem bygget p\u00e5 Firebase.</p>"},{"location":"#oversikt","title":"Oversikt","text":"<p>GolfChart lar golfklubber administrere utleie av golfbiler med:</p> <ul> <li>Multi-klubb st\u00f8tte \u2014 Ett system for flere klubber med full dataisolasjon</li> <li>Admin backoffice \u2014 Komplett administrasjonspanel for drift</li> <li>Sanntids oppdateringer \u2014 Firebase Firestore for live status</li> <li>Automatiserte varsler \u2014 E-post og SMS p\u00e5minnelser</li> <li>AI-assistent \u2014 Gemini-drevet hjelp for personalet</li> <li>Rapportering \u2014 Eksport og analyse av utleiedata</li> </ul>"},{"location":"#rask-start","title":"Rask start","text":"<pre><code># Installer avhengigheter\nnpm install\n\n# Start lokal utvikling\ncd admin\nnpm run dev\n\n# Start Firebase emulatorer\nfirebase emulators:start\n</code></pre>"},{"location":"#arkitektur","title":"Arkitektur","text":"<pre><code>graph TB\n    A[Admin SPA] --&gt;|Firebase Auth| B[Cloud Functions]\n    A --&gt;|Real-time| C[Firestore]\n    B --&gt; C\n    B --&gt;|Varsler| D[SendGrid/Twilio]\n    B --&gt;|AI| E[Gemini API]\n    C --&gt;|Regler| F[Security Rules]</code></pre>"},{"location":"#hovedfunksjoner","title":"Hovedfunksjoner","text":""},{"location":"#for-administratorer","title":"For administratorer","text":"<ul> <li>Dashboard med sanntidsoversikt</li> <li>H\u00e5ndtering av golfbiler (status, vedlikehold)</li> <li>Opprett og avslutt utleier</li> <li>Prisredigering per klubb</li> <li>Rapportgenerering (CSV/JSON)</li> <li>Bruker- og rollestyring</li> </ul>"},{"location":"#for-ansatte","title":"For ansatte","text":"<ul> <li>Registrer nye utleier</li> <li>Avslutt p\u00e5g\u00e5ende utleier</li> <li>Sett biler ute av drift</li> <li>Se utleiehistorikk</li> <li>AI-assistent for sp\u00f8rsm\u00e5l</li> </ul>"},{"location":"#for-teknisk-drift","title":"For teknisk drift","text":"<ul> <li>Multi-milj\u00f8 (dev, stage, prod)</li> <li>CI/CD med GitHub Actions</li> <li>Strukturert logging</li> <li>Sikker n\u00f8kkelh\u00e5ndtering</li> <li>Automatisk backup</li> </ul>"},{"location":"#neste-steg","title":"Neste steg","text":"<ul> <li>Firebase oppsett \u2014 Kom i gang med Firebase</li> <li>Lokal utvikling \u2014 Sett opp lokalt milj\u00f8</li> <li>Datamodell \u2014 Forst\u00e5 databasestrukturen</li> <li>API referanse \u2014 Cloud Functions dokumentasjon</li> </ul>"},{"location":"#support","title":"Support","text":"<p>For sp\u00f8rsm\u00e5l og problemer: - GitHub Issues: github.com/your-org/golfchart/issues - Dokumentasjon: golfbilkontroll-skigk.web.app/docs</p>"},{"location":"#lisens","title":"Lisens","text":"<p>Copyright \u00a9 2025 GolfChart Team. Alle rettigheter reservert.</p>"},{"location":"api/overview/","title":"API Oversikt","text":"<p>GolfChart eksponerer et sett med Cloud Functions for \u00e5 h\u00e5ndtere backend-logikk som krever server-side validering, transaksjoner, og integrasjoner med eksterne tjenester.</p>"},{"location":"api/overview/#tilgjengelige-endpoints","title":"Tilgjengelige endpoints","text":"Funksjon Beskrivelse Autentisering Roller <code>createRental</code> Opprett ny utleie \u2705 staff, clubAdmin, superadmin <code>endRental</code> Avslutt p\u00e5g\u00e5ende utleie \u2705 staff, clubAdmin, superadmin <code>updateCartStatus</code> Endre cart status \u2705 staff, clubAdmin, superadmin <code>sendNotification</code> Send e-post/SMS \u2705 staff, clubAdmin, superadmin <code>generateReport</code> Generer rapport (scheduled) \u274c N/A (cron) <code>setUserRole</code> Sett brukerrolle \u2705 superadmin"},{"location":"api/overview/#base-url","title":"Base URL","text":"<p>Produksjon:</p> <pre><code>https://europe-west1-golfbilkontroll-skigk.cloudfunctions.net\n</code></pre> <p>Emulator (lokal):</p> <pre><code>http://localhost:5001/golfbilkontroll-skigk/europe-west1\n</code></pre>"},{"location":"api/overview/#autentisering","title":"Autentisering","text":"<p>Alle callable functions krever Firebase Auth ID token:</p> <pre><code>// admin/src/api/client.ts\nimport { getFunctions, httpsCallable } from 'firebase/functions';\nimport { getAuth } from 'firebase/auth';\n\nconst functions = getFunctions(app, 'europe-west1');\n\nexport async function callFunction&lt;T&gt;(name: string, data: any): Promise&lt;T&gt; {\n  const auth = getAuth();\n  const user = auth.currentUser;\n\n  if (!user) {\n    throw new Error('Ikke innlogget');\n  }\n\n  const fn = httpsCallable&lt;any, T&gt;(functions, name);\n  const result = await fn(data);\n  return result.data;\n}\n</code></pre>"},{"location":"api/overview/#feilhandtering","title":"Feilh\u00e5ndtering","text":"<p>Functions returnerer standard Firebase <code>HttpsError</code> ved feil:</p> <pre><code>// Eksempel respons ved feil\n{\n  \"code\": \"permission-denied\",\n  \"message\": \"Ikke tilgang til denne klubben\",\n  \"details\": {\n    \"clubId\": \"ski-gk\",\n    \"userClubs\": [\"holmenkollen-gk\"]\n  }\n}\n</code></pre> <p>Feilkoder:</p> Kode Betydning <code>unauthenticated</code> Bruker er ikke innlogget <code>permission-denied</code> Mangler n\u00f8dvendig rolle eller klubbtilgang <code>invalid-argument</code> Ugyldig input-data <code>not-found</code> Ressurs ikke funnet <code>already-exists</code> Ressurs eksisterer allerede <code>resource-exhausted</code> Rate limit overskredet <code>internal</code> Intern serverfeil"},{"location":"api/overview/#rate-limiting","title":"Rate limiting","text":"<p>App Check er aktivert for alle functions:</p> <pre><code>export const myFunction = onCall(\n  {\n    enforceAppCheck: true,\n    consumeAppCheckToken: true\n  },\n  async (data, context) =&gt; {\n    // Handler\n  }\n);\n</code></pre> <p>Grenser:</p> <ul> <li>Standard: 100 requests/min per IP</li> <li>Authenticated: 1000 requests/min per bruker</li> </ul>"},{"location":"api/overview/#eksempel-createrental","title":"Eksempel: createRental","text":""},{"location":"api/overview/#request","title":"Request","text":"<pre><code>import { callFunction } from '@/api/client';\n\nconst result = await callFunction&lt;{ rentalId: string; price: number }&gt;('createRental', {\n  clubId: 'ski-gk',\n  cartId: 'cart123',\n  renterName: 'Ola Nordmann',\n  membershipNumber: '73-12345',\n  hasDoctorsNote: false,\n  holes: 18,\n  paymentMethod: 'Kort',\n  notificationMethod: 'email',\n  contactInfo: 'ola@example.com',\n  notes: 'Forh\u00e5ndsbooket'\n});\n\nconsole.log(`Rental ${result.rentalId} opprettet, pris: ${result.price} kr`);\n</code></pre>"},{"location":"api/overview/#response","title":"Response","text":"<pre><code>{\n  \"rentalId\": \"rental_20251203_001\",\n  \"price\": 350,\n  \"startTime\": \"2025-12-03T10:00:00.000Z\"\n}\n</code></pre>"},{"location":"api/overview/#flow","title":"Flow","text":"<pre><code>sequenceDiagram\n    participant UI as Admin UI\n    participant CF as createRental\n    participant Auth as Firebase Auth\n    participant FS as Firestore\n    participant Email as SendGrid\n\n    UI-&gt;&gt;CF: createRental(data)\n    CF-&gt;&gt;Auth: Verify ID token\n    Auth--&gt;&gt;CF: Valid + Custom Claims\n    CF-&gt;&gt;CF: Validate clubId access\n    CF-&gt;&gt;FS: Transaksjon START\n    CF-&gt;&gt;FS: Les cart (sjekk available)\n    CF-&gt;&gt;FS: Les pricingRules\n    CF-&gt;&gt;CF: Beregn pris\n    CF-&gt;&gt;FS: Opprett rental\n    CF-&gt;&gt;FS: Oppdater cart.status = 'rented'\n    CF-&gt;&gt;FS: Transaksjon COMMIT\n    CF-&gt;&gt;Email: Send notifikasjon (async)\n    CF--&gt;&gt;UI: { rentalId, price }</code></pre>"},{"location":"api/overview/#testing","title":"Testing","text":""},{"location":"api/overview/#lokal-testing-emulator","title":"Lokal testing (Emulator)","text":"<pre><code>// admin/src/firebase.ts\nimport { connectFunctionsEmulator } from 'firebase/functions';\n\nif (import.meta.env.VITE_USE_EMULATOR === 'true') {\n  connectFunctionsEmulator(functions, 'localhost', 5001);\n}\n</code></pre>"},{"location":"api/overview/#integration-tests","title":"Integration tests","text":"<pre><code>// tests/functions.test.ts\nimport { wrap } from 'firebase-functions-test';\n\nconst testEnv = wrap();\n\ndescribe('createRental', () =&gt; {\n  it('should create rental and update cart', async () =&gt; {\n    const data = {\n      clubId: 'ski-gk',\n      cartId: 'cart123',\n      renterName: 'Test User',\n      holes: 18\n    };\n\n    const context = {\n      auth: {\n        uid: 'user123',\n        token: {\n          role: 'staff',\n          clubs: ['ski-gk']\n        }\n      }\n    };\n\n    const result = await createRental(data, context);\n\n    expect(result.rentalId).toBeDefined();\n    expect(result.price).toBe(350);\n  });\n});\n</code></pre>"},{"location":"api/overview/#best-practices","title":"Best practices","text":""},{"location":"api/overview/#do","title":"\u2705 Do:","text":"<ul> <li>Alltid valider input i functions</li> <li>Bruk transaksjoner for multi-step operasjoner</li> <li>Logg alle kritiske operasjoner</li> <li>H\u00e5ndter race conditions (f.eks. to utleier p\u00e5 samme cart samtidig)</li> <li>Bruk structured logging</li> </ul>"},{"location":"api/overview/#dont","title":"\u274c Don't:","text":"<ul> <li>Ikke stol p\u00e5 frontend-validering alene</li> <li>Ikke gj\u00f8r tunge operasjoner i functions (cold start)</li> <li>Ikke returner sensitive data i error messages</li> <li>Ikke glem \u00e5 validere clubId-tilgang</li> </ul>"},{"location":"api/overview/#neste-steg","title":"Neste steg","text":"<ul> <li>Auth API \u2014 Autentisering og brukeradministrasjon</li> <li>Firestore API \u2014 Direkte Firestore queries</li> <li>Functions API \u2014 Detaljert dokumentasjon per function</li> </ul>"},{"location":"architecture/data-model/","title":"Datamodell","text":"<p>GolfChart bruker Firestore med en multi-klubb arkitektur hvor alle dokumenter er tagget med <code>clubId</code> for dataisolasjon.</p>"},{"location":"architecture/data-model/#oversikt","title":"Oversikt","text":"<pre><code>erDiagram\n    CLUBS ||--o{ CARTS : owns\n    CLUBS ||--o{ PRICING_RULES : defines\n    CLUBS ||--o{ RENTALS : has\n    CARTS ||--o{ RENTALS : used_in\n    CARTS ||--o{ MAINTENANCE_LOGS : has\n    RENTALS ||--o{ MESSAGES : triggers\n\n    CLUBS {\n        string clubId PK\n        string name\n        string slug\n        boolean active\n        object contact\n        string timezone\n    }\n\n    CARTS {\n        string cartId PK\n        string clubId FK\n        string status\n        string label\n        string serial\n    }\n\n    RENTALS {\n        string rentalId PK\n        string clubId FK\n        string cartId FK\n        string renterName\n        boolean isMember\n        number holes\n        number price\n        timestamp startTime\n        timestamp endTime\n    }</code></pre>"},{"location":"architecture/data-model/#kolleksjoner","title":"Kolleksjoner","text":""},{"location":"architecture/data-model/#clubs","title":"clubs","text":"<p>Basisinformasjon om hver golfklubb.</p> <p>Dokument-ID: Manuelt satt slug (f.eks. <code>ski-gk</code>)</p> <pre><code>interface Club {\n  name: string;              // \"Ski Golfklubb\"\n  slug: string;              // \"ski-gk\" (samme som doc ID)\n  active: boolean;           // Er klubben aktiv?\n  contact: {\n    email: string;\n    phone: string;\n    address?: string;\n  };\n  timezone: string;          // \"Europe/Oslo\"\n  createdAt: Timestamp;\n  updatedAt: Timestamp;\n}\n</code></pre> <p>Eksempel:</p> <pre><code>{\n  \"name\": \"Ski Golfklubb\",\n  \"slug\": \"ski-gk\",\n  \"active\": true,\n  \"contact\": {\n    \"email\": \"postkasse@skigk.no\",\n    \"phone\": \"+47 64 88 99 42\"\n  },\n  \"timezone\": \"Europe/Oslo\",\n  \"createdAt\": \"2025-11-17T10:00:00.000Z\",\n  \"updatedAt\": \"2025-11-17T10:00:00.000Z\"\n}\n</code></pre>"},{"location":"architecture/data-model/#pricingrules","title":"pricingRules","text":"<p>Prisregler per klubb for medlemmer/ikke-medlemmer og 9/18 hull.</p> <p>Dokument-ID: Auto-generert eller <code>{clubId}_default</code></p> <pre><code>interface PricingRule {\n  clubId: string;            // FK til clubs\n  holes18: {\n    member: number;          // 350\n    nonMember: number;       // 425\n  };\n  holes9: {\n    member: number;          // 200\n    nonMember: number;       // 250\n  };\n  doctorsNoteDiscount: number; // 50\n  effectiveFrom: Timestamp;\n  effectiveTo?: Timestamp;   // null = aktiv\n}\n</code></pre> <p>Eksempel:</p> <pre><code>{\n  \"clubId\": \"ski-gk\",\n  \"holes18\": {\n    \"member\": 350,\n    \"nonMember\": 425\n  },\n  \"holes9\": {\n    \"member\": 200,\n    \"nonMember\": 250\n  },\n  \"doctorsNoteDiscount\": 50,\n  \"effectiveFrom\": \"2025-01-01T00:00:00.000Z\",\n  \"effectiveTo\": null\n}\n</code></pre>"},{"location":"architecture/data-model/#carts","title":"carts","text":"<p>Golfbiler tilh\u00f8rende en klubb.</p> <p>Dokument-ID: Auto-generert eller <code>{clubId}_cart_{n}</code></p> <pre><code>type CartStatus = 'available' | 'rented' | 'out_of_order';\n\ninterface Cart {\n  clubId: string;            // FK til clubs\n  status: CartStatus;\n  label: string;             // \"Bil 1\", \"Bil 2\"\n  serial?: string;           // Serienummer\n  notes?: string;\n  currentRentalId?: string;  // FK til aktiv rental (hvis rented)\n  createdAt: Timestamp;\n  updatedAt: Timestamp;\n}\n</code></pre> <p>Eksempel:</p> <pre><code>{\n  \"clubId\": \"ski-gk\",\n  \"status\": \"available\",\n  \"label\": \"Bil 1\",\n  \"serial\": \"GOLF-2023-001\",\n  \"notes\": \"\",\n  \"currentRentalId\": null,\n  \"createdAt\": \"2025-11-17T10:00:00.000Z\",\n  \"updatedAt\": \"2025-12-03T14:30:00.000Z\"\n}\n</code></pre>"},{"location":"architecture/data-model/#rentals","title":"rentals","text":"<p>Utleietransaksjoner (b\u00e5de aktive og historiske).</p> <p>Dokument-ID: Auto-generert timestamp-basert</p> <pre><code>interface Rental {\n  clubId: string;            // FK til clubs\n  cartId: string;            // FK til carts\n  renterName: string;\n  membershipNumber?: string; // \"73-12345\"\n  isMember: boolean;         // Beregnet fra membershipNumber\n  hasDoctorsNote: boolean;\n  holes: 9 | 18;\n  price: number;             // Beregnet pris\n  paymentMethod?: string;    // \"Kort\", \"Vipps\", \"Kontant\"\n  startTime: Timestamp;\n  endTime?: Timestamp;       // null = p\u00e5g\u00e5ende\n  notificationMethod?: 'email' | 'sms';\n  contactInfo?: string;      // E-post eller telefon\n  reminderSent: boolean;\n  notes?: string;\n  createdAt: Timestamp;\n  updatedAt: Timestamp;\n}\n</code></pre> <p>Eksempel:</p> <pre><code>{\n  \"clubId\": \"ski-gk\",\n  \"cartId\": \"ski-gk_cart_1\",\n  \"renterName\": \"Ola Nordmann\",\n  \"membershipNumber\": \"73-12345\",\n  \"isMember\": true,\n  \"hasDoctorsNote\": false,\n  \"holes\": 18,\n  \"price\": 350,\n  \"paymentMethod\": \"Kort\",\n  \"startTime\": \"2025-12-03T09:00:00.000Z\",\n  \"endTime\": null,\n  \"notificationMethod\": \"email\",\n  \"contactInfo\": \"ola@example.com\",\n  \"reminderSent\": false,\n  \"notes\": \"Forh\u00e5ndsbooket online\",\n  \"createdAt\": \"2025-12-03T08:45:00.000Z\",\n  \"updatedAt\": \"2025-12-03T08:45:00.000Z\"\n}\n</code></pre>"},{"location":"architecture/data-model/#maintenancelogs","title":"maintenanceLogs","text":"<p>Vedlikeholdslogg n\u00e5r biler settes ute av drift eller repareres.</p> <p>Dokument-ID: Auto-generert</p> <pre><code>interface MaintenanceLog {\n  clubId: string;\n  cartId: string;\n  statusBefore: CartStatus;\n  statusAfter: CartStatus;\n  reason: string;\n  byUser: string;           // UID til bruker som gjorde endringen\n  timestamp: Timestamp;\n}\n</code></pre> <p>Eksempel:</p> <pre><code>{\n  \"clubId\": \"ski-gk\",\n  \"cartId\": \"ski-gk_cart_2\",\n  \"statusBefore\": \"available\",\n  \"statusAfter\": \"out_of_order\",\n  \"reason\": \"Bremsefeil - sendt til verksted\",\n  \"byUser\": \"user_abc123\",\n  \"timestamp\": \"2025-12-03T10:15:00.000Z\"\n}\n</code></pre>"},{"location":"architecture/data-model/#users","title":"users","text":"<p>Brukerprofiler (speiler Firebase Auth).</p> <p>Dokument-ID: Samme som Firebase Auth UID</p> <pre><code>interface User {\n  email: string;\n  displayName?: string;\n  clubs: string[];          // Liste av clubIds brukeren har tilgang til\n  roles: string[];          // Lokal kopi av custom claims\n  createdAt: Timestamp;\n  lastLogin?: Timestamp;\n}\n</code></pre> <p>Eksempel:</p> <pre><code>{\n  \"email\": \"admin@skigk.no\",\n  \"displayName\": \"Admin Bruker\",\n  \"clubs\": [\"ski-gk\"],\n  \"roles\": [\"clubAdmin\"],\n  \"createdAt\": \"2025-11-17T10:00:00.000Z\",\n  \"lastLogin\": \"2025-12-03T08:00:00.000Z\"\n}\n</code></pre>"},{"location":"architecture/data-model/#messages","title":"messages","text":"<p>Logg over sendte varsler (e-post/SMS).</p> <p>Dokument-ID: Auto-generert</p> <pre><code>type MessageStatus = 'pending' | 'sent' | 'failed';\n\ninterface Message {\n  clubId: string;\n  method: 'email' | 'sms';\n  to: string;\n  templateId?: string;\n  body?: string;\n  status: MessageStatus;\n  retries: number;\n  error?: string;\n  sentAt?: Timestamp;\n  createdAt: Timestamp;\n}\n</code></pre>"},{"location":"architecture/data-model/#reports","title":"reports","text":"<p>Genererte rapporter og eksporter.</p> <p>Dokument-ID: Auto-generert</p> <pre><code>interface Report {\n  clubId: string;\n  type: 'rentals' | 'revenue' | 'maintenance';\n  range: {\n    from: Timestamp;\n    to: Timestamp;\n  };\n  status: 'generating' | 'completed' | 'failed';\n  storagePath?: string;     // Sti til CSV/JSON i Storage\n  createdAt: Timestamp;\n  completedAt?: Timestamp;\n}\n</code></pre>"},{"location":"architecture/data-model/#indekser","title":"Indekser","text":"<p>Firestore krever indekser for sammensatte queries:</p>"},{"location":"architecture/data-model/#rentals_1","title":"rentals","text":"<pre><code>{\n  \"collectionGroup\": \"rentals\",\n  \"queryScope\": \"COLLECTION\",\n  \"fields\": [\n    { \"fieldPath\": \"clubId\", \"order\": \"ASCENDING\" },\n    { \"fieldPath\": \"startTime\", \"order\": \"DESCENDING\" }\n  ]\n}\n</code></pre>"},{"location":"architecture/data-model/#carts_1","title":"carts","text":"<pre><code>{\n  \"collectionGroup\": \"carts\",\n  \"queryScope\": \"COLLECTION\",\n  \"fields\": [\n    { \"fieldPath\": \"clubId\", \"order\": \"ASCENDING\" },\n    { \"fieldPath\": \"status\", \"order\": \"ASCENDING\" }\n  ]\n}\n</code></pre>"},{"location":"architecture/data-model/#maintenancelogs_1","title":"maintenanceLogs","text":"<pre><code>{\n  \"collectionGroup\": \"maintenanceLogs\",\n  \"queryScope\": \"COLLECTION\",\n  \"fields\": [\n    { \"fieldPath\": \"cartId\", \"order\": \"ASCENDING\" },\n    { \"fieldPath\": \"timestamp\", \"order\": \"DESCENDING\" }\n  ]\n}\n</code></pre> <p>Disse er definert i <code>firestore.indexes.json</code> og deployes med:</p> <pre><code>firebase deploy --only firestore:indexes\n</code></pre>"},{"location":"architecture/data-model/#transaksjoner","title":"Transaksjoner","text":"<p>Kritiske operasjoner bruker Firestore-transaksjoner:</p>"},{"location":"architecture/data-model/#createrental","title":"createRental","text":"<ol> <li>Les cart for \u00e5 sjekke status</li> <li>Les pricingRules for \u00e5 beregne pris</li> <li>Opprett rental-dokument</li> <li>Oppdater cart.status til 'rented' og sett currentRentalId</li> </ol>"},{"location":"architecture/data-model/#endrental","title":"endRental","text":"<ol> <li>Les rental-dokument</li> <li>Sett rental.endTime</li> <li>Oppdater cart.status til 'available' og fjern currentRentalId</li> </ol>"},{"location":"architecture/data-model/#neste-steg","title":"Neste steg","text":"<ul> <li>Sikkerhetsmodell \u2014 Firestore security rules</li> <li>API referanse \u2014 Query-patterns og beste praksis</li> <li>Multi-klubb design \u2014 Isolasjon og skalering</li> </ul>"},{"location":"architecture/multi-tenant/","title":"Multi-tenancy design","text":"<p>GolfChart bruker en shared database med clubId-basert isolasjon for \u00e5 st\u00f8tte flere golfklubber i samme Firebase-prosjekt.</p>"},{"location":"architecture/multi-tenant/#designvalg","title":"Designvalg","text":""},{"location":"architecture/multi-tenant/#shared-vs-separate-projects","title":"Shared vs Separate projects","text":"<p>Vi valgte shared database fremfor separate Firebase-prosjekter per klubb:</p> <p>Fordeler:</p> <ul> <li>\u2705 Enklere vedlikehold (\u00e9n kodebase, ett deployment)</li> <li>\u2705 Kostnadseffektivt for sm\u00e5 klubber</li> <li>\u2705 Sentralisert logging og monitoring</li> <li>\u2705 Enklere brukeradministrasjon (\u00e9n Auth pool)</li> </ul> <p>Ulemper:</p> <ul> <li>\u274c Krever streng security rules-h\u00e5ndtering</li> <li>\u274c Alle queries m\u00e5 filtrere p\u00e5 clubId</li> <li>\u274c Risiko for data-lekkasje hvis security rules er feil</li> </ul>"},{"location":"architecture/multi-tenant/#clubid-isolasjon","title":"ClubId-isolasjon","text":""},{"location":"architecture/multi-tenant/#data-modell","title":"Data modell","text":"<p>Alle Firestore-dokumenter har et <code>clubId</code> felt:</p> <pre><code>interface BaseDocument {\n  clubId: string;  // OBLIGATORISK\n  createdAt: Timestamp;\n  updatedAt: Timestamp;\n}\n\ninterface Cart extends BaseDocument {\n  // ... andre felter\n}\n\ninterface Rental extends BaseDocument {\n  // ... andre felter\n}\n</code></pre>"},{"location":"architecture/multi-tenant/#query-patterns","title":"Query patterns","text":"<p>\u274c ALDRI gj\u00f8r dette (global query):</p> <pre><code>// FARLIG: Returnerer data fra ALLE klubber\nconst snapshot = await getDocs(collection(db, 'rentals'));\n</code></pre> <p>\u2705 ALLTID gj\u00f8r dette (clubId-filtrert query):</p> <pre><code>// TRYGT: Kun data fra \u00e9n klubb\nconst q = query(\n  collection(db, 'rentals'),\n  where('clubId', '==', currentClubId)\n);\nconst snapshot = await getDocs(q);\n</code></pre>"},{"location":"architecture/multi-tenant/#custom-react-hook","title":"Custom React Hook","text":"<p>Lag en abstraksjon for \u00e5 sikre clubId alltid er med:</p> <pre><code>// admin/src/hooks/useClubQuery.ts\nimport { useAuth } from '@/contexts/AuthContext';\nimport { useQuery } from '@tanstack/react-query';\n\nexport function useClubQuery&lt;T&gt;(\n  collectionName: string,\n  additionalFilters?: QueryConstraint[]\n) {\n  const { currentClubId } = useAuth();\n\n  return useQuery({\n    queryKey: [collectionName, currentClubId, ...additionalFilters],\n    queryFn: async () =&gt; {\n      if (!currentClubId) throw new Error('Ingen klubb valgt');\n\n      const q = query(\n        collection(db, collectionName),\n        where('clubId', '==', currentClubId),\n        ...(additionalFilters || [])\n      );\n\n      const snapshot = await getDocs(q);\n      return snapshot.docs.map(doc =&gt; ({\n        id: doc.id,\n        ...doc.data()\n      })) as T[];\n    },\n    enabled: !!currentClubId\n  });\n}\n</code></pre> <p>Bruk:</p> <pre><code>// admin/src/pages/RentalsPage.tsx\nconst { data: rentals, isLoading } = useClubQuery&lt;Rental&gt;(\n  'rentals',\n  [orderBy('startTime', 'desc'), limit(50)]\n);\n</code></pre>"},{"location":"architecture/multi-tenant/#bruker-klubb-mapping","title":"Bruker-klubb mapping","text":""},{"location":"architecture/multi-tenant/#custom-claims","title":"Custom Claims","text":"<p>Brukere f\u00e5r en liste av klubber de har tilgang til:</p> <pre><code>interface CustomClaims {\n  role: 'superadmin' | 'clubAdmin' | 'staff' | 'viewer';\n  clubs: string[];  // [\"ski-gk\", \"holmenkollen-gk\"]\n}\n</code></pre>"},{"location":"architecture/multi-tenant/#klubbvelger-i-ui","title":"Klubbvelger i UI","text":"<p>Admin UI har en klubbvelger i headeren:</p> <pre><code>// admin/src/components/ClubSelector.tsx\nexport function ClubSelector() {\n  const { claims } = useAuth();\n  const [currentClub, setCurrentClub] = useLocalStorage('currentClubId', '');\n\n  const userClubs = claims?.clubs || [];\n\n  if (claims?.role === 'superadmin') {\n    // Superadmin ser alle klubber\n    return &lt;ClubDropdown clubs={allClubs} /&gt;;\n  }\n\n  // Andre roller ser kun sine klubber\n  return &lt;ClubDropdown clubs={userClubs} /&gt;;\n}\n</code></pre>"},{"location":"architecture/multi-tenant/#security-rules-validering","title":"Security Rules validering","text":"<p>Firestore Security Rules h\u00e5ndhever clubId-isolasjon:</p> <pre><code>// firestore.rules\nfunction hasClubAccess(clubId) {\n  return request.auth != null &amp;&amp; \n         clubId in request.auth.token.clubs;\n}\n\nmatch /rentals/{rentalId} {\n  // Les: M\u00e5 ha tilgang til klubben\n  allow read: if hasClubAccess(resource.data.clubId);\n\n  // Skriv: M\u00e5 ha tilgang OG clubId m\u00e5 matche i request\n  allow create, update: if hasClubAccess(request.resource.data.clubId) &amp;&amp;\n                           request.resource.data.clubId == resource.data.clubId;\n}\n</code></pre> <p>Viktig: <code>request.resource.data.clubId == resource.data.clubId</code> forhindrer at noen endrer clubId p\u00e5 eksisterende dokumenter.</p>"},{"location":"architecture/multi-tenant/#cloud-functions-isolasjon","title":"Cloud Functions isolasjon","text":"<p>Cloud Functions m\u00e5 validere clubId-tilgang:</p> <pre><code>// functions/src/rentals.ts\nexport const createRental = onCall(async (data, context) =&gt; {\n  const { clubId, cartId, renterName } = data;\n  const userClubs = context.auth?.token.clubs as string[];\n\n  // Valider at bruker har tilgang til klubben\n  if (!userClubs.includes(clubId)) {\n    throw new HttpsError('permission-denied', 'Ikke tilgang til denne klubben');\n  }\n\n  // Valider at cart tilh\u00f8rer klubben\n  const cartDoc = await admin.firestore().doc(`carts/${cartId}`).get();\n  if (!cartDoc.exists || cartDoc.data()?.clubId !== clubId) {\n    throw new HttpsError('invalid-argument', 'Ugyldig cart for denne klubben');\n  }\n\n  // Fortsett med transaksjon...\n});\n</code></pre>"},{"location":"architecture/multi-tenant/#testing-av-isolasjon","title":"Testing av isolasjon","text":""},{"location":"architecture/multi-tenant/#unit-tests","title":"Unit tests","text":"<p>Test at queries alltid inkluderer clubId:</p> <pre><code>// admin/src/hooks/__tests__/useClubQuery.test.ts\nimport { renderHook, waitFor } from '@testing-library/react';\nimport { useClubQuery } from '../useClubQuery';\n\ndescribe('useClubQuery', () =&gt; {\n  it('should filter by clubId', async () =&gt; {\n    const { result } = renderHook(() =&gt; useClubQuery('rentals'));\n\n    await waitFor(() =&gt; expect(result.current.isSuccess).toBe(true));\n\n    // Alle dokumenter skal ha currentClubId\n    result.current.data?.forEach(rental =&gt; {\n      expect(rental.clubId).toBe('ski-gk');\n    });\n  });\n\n  it('should throw if no clubId selected', () =&gt; {\n    // Mock ingen klubb valgt\n    const { result } = renderHook(() =&gt; useClubQuery('rentals'));\n\n    expect(result.current.isError).toBe(true);\n    expect(result.current.error?.message).toContain('Ingen klubb valgt');\n  });\n});\n</code></pre>"},{"location":"architecture/multi-tenant/#integration-tests","title":"Integration tests","text":"<p>Test Security Rules med Firebase Emulator:</p> <pre><code>// tests/security-rules.test.ts\nimport { \n  initializeTestEnvironment, \n  assertFails, \n  assertSucceeds \n} from '@firebase/rules-unit-testing';\n\nlet testEnv: RulesTestEnvironment;\n\nbeforeAll(async () =&gt; {\n  testEnv = await initializeTestEnvironment({\n    projectId: 'golfchart-test',\n    firestore: {\n      rules: fs.readFileSync('firestore.rules', 'utf8')\n    }\n  });\n});\n\ntest('bruker kan kun lese egne klubbers data', async () =&gt; {\n  const userContext = testEnv.authenticatedContext('user123', {\n    clubs: ['ski-gk']\n  });\n\n  // Skal lykkes: Leser egen klubb\n  await assertSucceeds(\n    userContext.firestore()\n      .collection('rentals')\n      .where('clubId', '==', 'ski-gk')\n      .get()\n  );\n\n  // Skal feile: Pr\u00f8ver \u00e5 lese annen klubb\n  await assertFails(\n    userContext.firestore()\n      .collection('rentals')\n      .where('clubId', '==', 'holmenkollen-gk')\n      .get()\n  );\n});\n</code></pre>"},{"location":"architecture/multi-tenant/#skalering","title":"Skalering","text":""},{"location":"architecture/multi-tenant/#nar-en-database-ikke-er-nok","title":"N\u00e5r \u00e9n database ikke er nok","text":"<p>Hvis systemet vokser til 100+ klubber eller har sv\u00e6rt ulike behov (forskjellige regioner, compliance-krav), vurder:</p>"},{"location":"architecture/multi-tenant/#1-database-per-region","title":"1. Database-per-region","text":"<pre><code>Firebase Project: golfchart-norway\n  \u2514\u2500\u2500 Firestore (europe-north1)\n      \u2514\u2500\u2500 Klubber: ski-gk, holmenkollen-gk, ...\n\nFirebase Project: golfchart-sweden\n  \u2514\u2500\u2500 Firestore (europe-north1)\n      \u2514\u2500\u2500 Klubber: stockholms-gk, ...\n</code></pre>"},{"location":"architecture/multi-tenant/#2-collection-groups","title":"2. Collection Groups","text":"<p>Bruk sub-collections for bedre sharding:</p> <pre><code>/clubs/{clubId}/rentals/{rentalId}\n/clubs/{clubId}/carts/{cartId}\n</code></pre> <p>Query med collection groups:</p> <pre><code>const q = query(\n  collectionGroup(db, 'rentals'),\n  where('clubId', '==', currentClubId)\n);\n</code></pre> <p>Fordel: Automatisk sharding per klubb.</p> <p>Ulempe: Mer komplekse security rules.</p>"},{"location":"architecture/multi-tenant/#monitoring-og-alerts","title":"Monitoring og alerts","text":""},{"location":"architecture/multi-tenant/#datadog-dashboard","title":"Datadog dashboard","text":"<p>Overv\u00e5k queries for \u00e5 sikre at clubId alltid er med:</p> <pre><code>{\n  \"query\": \"SELECT COUNT(*) FROM firestore_queries WHERE missing_clubId = true\",\n  \"alert\": {\n    \"threshold\": 0,\n    \"message\": \"KRITISK: Query uten clubId-filter detektert!\"\n  }\n}\n</code></pre>"},{"location":"architecture/multi-tenant/#cloud-functions-metrics","title":"Cloud Functions metrics","text":"<p>Log clubId i alle function calls:</p> <pre><code>import { logger } from 'firebase-functions/v2';\n\nexport const createRental = onCall(async (data, context) =&gt; {\n  logger.info('createRental', {\n    uid: context.auth?.uid,\n    clubId: data.clubId,\n    timestamp: new Date().toISOString()\n  });\n  // ...\n});\n</code></pre> <p>Bygg dashboard som viser aktivitet per klubb.</p>"},{"location":"architecture/multi-tenant/#best-practices","title":"Best practices","text":""},{"location":"architecture/multi-tenant/#do","title":"\u2705 Do:","text":"<ul> <li>Alltid inkluder clubId i alle Firestore queries</li> <li>Valider clubId i alle Cloud Functions</li> <li>Bruk custom hooks som abstraherer clubId-filtrering</li> <li>Test security rules grundig med emulator</li> <li>Logg clubId i alle logger for debugging</li> <li>Lag alerts for queries uten clubId</li> </ul>"},{"location":"architecture/multi-tenant/#dont","title":"\u274c Don't:","text":"<ul> <li>ALDRI tillat global queries uten clubId</li> <li>ALDRI stol p\u00e5 frontend-validering alene</li> <li>ALDRI hardkod clubId (alltid hent fra context/claims)</li> <li>ALDRI tillat clubId-endring p\u00e5 eksisterende dokumenter</li> <li>ALDRI glem \u00e5 teste cross-club access scenarios</li> </ul>"},{"location":"architecture/multi-tenant/#neste-steg","title":"Neste steg","text":"<ul> <li>Sikkerhetsmodell \u2014 Security Rules i detalj</li> <li>Datamodell \u2014 Firestore collections og struktur</li> <li>API dokumentasjon \u2014 Query patterns og best practices</li> </ul>"},{"location":"architecture/security/","title":"Sikkerhetsmodell","text":"<p>Sikkerheten i GolfChart er basert p\u00e5 Firebase Security Rules, Custom Claims, og defense-in-depth prinsippet.</p>"},{"location":"architecture/security/#firestore-security-rules","title":"Firestore Security Rules","text":""},{"location":"architecture/security/#overordnet-strategi","title":"Overordnet strategi","text":"<p>Alle Firestore Security Rules validerer:</p> <ol> <li>Autentisering \u2014 Bruker m\u00e5 v\u00e6re innlogget</li> <li>ClubId matching \u2014 Bruker m\u00e5 ha tilgang til riktig klubb via custom claims</li> <li>Role-basert tilgang \u2014 Ulike roller har ulike operasjoner</li> </ol>"},{"location":"architecture/security/#komplett-firestorerules","title":"Komplett firestore.rules","text":"<pre><code>rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Helper functions\n    function isAuthenticated() {\n      return request.auth != null;\n    }\n\n    function hasRole(role) {\n      return isAuthenticated() &amp;&amp; \n             request.auth.token.role == role;\n    }\n\n    function hasAnyRole(roles) {\n      return isAuthenticated() &amp;&amp; \n             request.auth.token.role in roles;\n    }\n\n    function hasClubAccess(clubId) {\n      return isAuthenticated() &amp;&amp; \n             clubId in request.auth.token.clubs;\n    }\n\n    function isOwner(userId) {\n      return isAuthenticated() &amp;&amp; \n             request.auth.uid == userId;\n    }\n\n    // --- CLUBS ---\n    match /clubs/{clubId} {\n      // Alle autentiserte kan lese klubber de har tilgang til\n      allow read: if hasClubAccess(clubId);\n\n      // Kun superadmin kan opprette nye klubber\n      allow create: if hasRole('superadmin');\n\n      // ClubAdmin og superadmin kan oppdatere\n      allow update: if hasClubAccess(clubId) &amp;&amp; \n                       hasAnyRole(['superadmin', 'clubAdmin']);\n\n      // Kun superadmin kan slette\n      allow delete: if hasRole('superadmin');\n    }\n\n    // --- PRICING RULES ---\n    match /pricingRules/{ruleId} {\n      allow read: if hasClubAccess(resource.data.clubId);\n\n      allow create, update: if hasClubAccess(request.resource.data.clubId) &amp;&amp;\n                               hasAnyRole(['superadmin', 'clubAdmin']);\n\n      allow delete: if hasRole('superadmin');\n    }\n\n    // --- CARTS ---\n    match /carts/{cartId} {\n      allow read: if hasClubAccess(resource.data.clubId);\n\n      // Staff, clubAdmin, superadmin kan opprette/oppdatere\n      allow create, update: if hasClubAccess(request.resource.data.clubId) &amp;&amp;\n                               hasAnyRole(['superadmin', 'clubAdmin', 'staff']);\n\n      allow delete: if hasRole('superadmin');\n    }\n\n    // --- RENTALS ---\n    match /rentals/{rentalId} {\n      allow read: if hasClubAccess(resource.data.clubId);\n\n      // Staff, clubAdmin, superadmin kan opprette/oppdatere\n      allow create, update: if hasClubAccess(request.resource.data.clubId) &amp;&amp;\n                               hasAnyRole(['superadmin', 'clubAdmin', 'staff']) &amp;&amp;\n                               request.resource.data.clubId == resource.data.clubId; // Forhindre clubId-endring\n\n      allow delete: if hasRole('superadmin');\n    }\n\n    // --- MAINTENANCE LOGS ---\n    match /maintenanceLogs/{logId} {\n      allow read: if hasClubAccess(resource.data.clubId);\n\n      // Alle med staff+ kan logge vedlikehold\n      allow create: if hasClubAccess(request.resource.data.clubId) &amp;&amp;\n                       hasAnyRole(['superadmin', 'clubAdmin', 'staff']) &amp;&amp;\n                       request.resource.data.byUser == request.auth.uid; // M\u00e5 logge seg selv\n\n      // Ingen kan endre eller slette logs (audit trail)\n      allow update, delete: if false;\n    }\n\n    // --- USERS ---\n    match /users/{userId} {\n      // Brukere kan lese sin egen profil\n      allow read: if isOwner(userId);\n\n      // Admins kan lese alle brukere i sine klubber\n      allow read: if hasAnyRole(['superadmin', 'clubAdmin']) &amp;&amp;\n                     hasClubAccess(resource.data.clubs[0]); // Sjekk minst \u00e9n klubb\n\n      // Kun superadmin kan opprette/oppdatere brukere\n      allow create, update: if hasRole('superadmin');\n\n      allow delete: if hasRole('superadmin');\n    }\n\n    // --- MESSAGES ---\n    match /messages/{messageId} {\n      // Kun admins kan se meldingslogg\n      allow read: if hasClubAccess(resource.data.clubId) &amp;&amp;\n                     hasAnyRole(['superadmin', 'clubAdmin']);\n\n      // Kun Cloud Functions kan skrive (via Admin SDK)\n      allow create, update, delete: if false;\n    }\n\n    // --- REPORTS ---\n    match /reports/{reportId} {\n      allow read: if hasClubAccess(resource.data.clubId) &amp;&amp;\n                     hasAnyRole(['superadmin', 'clubAdmin']);\n\n      // Kun Cloud Functions kan generere rapporter\n      allow create, update, delete: if false;\n    }\n\n    // Blokker alt annet\n    match /{document=**} {\n      allow read, write: if false;\n    }\n  }\n}\n</code></pre>"},{"location":"architecture/security/#custom-claims","title":"Custom Claims","text":""},{"location":"architecture/security/#struktur","title":"Struktur","text":"<p>Custom claims settes av en Cloud Function ved brukeropprettelse:</p> <pre><code>// functions/src/auth.ts\ninterface CustomClaims {\n  role: 'superadmin' | 'clubAdmin' | 'staff' | 'viewer';\n  clubs: string[];  // [\"ski-gk\", \"holmenkollen-gk\"]\n}\n\nexport const setUserRole = onCall(async (data, context) =&gt; {\n  // Kun superadmin kan sette roller\n  if (context.auth?.token.role !== 'superadmin') {\n    throw new HttpsError('permission-denied', 'Kun superadmin');\n  }\n\n  const { uid, role, clubs } = data;\n\n  await admin.auth().setCustomUserClaims(uid, {\n    role,\n    clubs\n  });\n\n  // Oppdater ogs\u00e5 Firestore users-dokument\n  await admin.firestore().doc(`users/${uid}`).update({\n    roles: [role],\n    clubs,\n    updatedAt: FieldValue.serverTimestamp()\n  });\n\n  return { success: true };\n});\n</code></pre>"},{"location":"architecture/security/#rollehierarki","title":"Rollehierarki","text":"<pre><code>superadmin\n  \u251c\u2500\u2500 Tilgang til ALLE klubber\n  \u251c\u2500\u2500 Kan opprette nye klubber\n  \u251c\u2500\u2500 Kan administrere brukere\n  \u2514\u2500\u2500 Kan slette data\n\nclubAdmin\n  \u251c\u2500\u2500 Tilgang til egne klubber (clubs array)\n  \u251c\u2500\u2500 Kan endre prisregler\n  \u251c\u2500\u2500 Kan se rapporter\n  \u2514\u2500\u2500 Kan administrere carts\n\nstaff\n  \u251c\u2500\u2500 Tilgang til egne klubber\n  \u251c\u2500\u2500 Kan opprette/avslutte rentals\n  \u251c\u2500\u2500 Kan endre cart status\n  \u2514\u2500\u2500 Lesetilgang til rapporter\n\nviewer\n  \u251c\u2500\u2500 Kun lesetilgang\n  \u2514\u2500\u2500 Kan ikke endre noe\n</code></pre>"},{"location":"architecture/security/#frontend-autentisering","title":"Frontend autentisering","text":""},{"location":"architecture/security/#admin-ui","title":"Admin UI","text":"<pre><code>// admin/src/contexts/AuthContext.tsx\nimport { onAuthStateChanged, signInWithEmailAndPassword } from 'firebase/auth';\n\nexport function AuthProvider({ children }: { children: ReactNode }) {\n  const [user, setUser] = useState&lt;User | null&gt;(null);\n  const [claims, setClaims] = useState&lt;CustomClaims | null&gt;(null);\n\n  useEffect(() =&gt; {\n    return onAuthStateChanged(auth, async (firebaseUser) =&gt; {\n      if (firebaseUser) {\n        const token = await firebaseUser.getIdTokenResult();\n        setClaims(token.claims as CustomClaims);\n        setUser(firebaseUser);\n      } else {\n        setUser(null);\n        setClaims(null);\n      }\n    });\n  }, []);\n\n  return (\n    &lt;AuthContext.Provider value={{ user, claims, signIn, signOut }}&gt;\n      {children}\n    &lt;/AuthContext.Provider&gt;\n  );\n}\n</code></pre>"},{"location":"architecture/security/#protected-routes","title":"Protected Routes","text":"<pre><code>// admin/src/components/ProtectedRoute.tsx\nexport function ProtectedRoute({ \n  children, \n  requiredRole \n}: { \n  children: ReactNode; \n  requiredRole?: CustomClaims['role'];\n}) {\n  const { user, claims } = useAuth();\n\n  if (!user) {\n    return &lt;Navigate to=\"/login\" /&gt;;\n  }\n\n  if (requiredRole &amp;&amp; claims?.role !== requiredRole) {\n    return &lt;Navigate to=\"/unauthorized\" /&gt;;\n  }\n\n  return &lt;&gt;{children}&lt;/&gt;;\n}\n</code></pre>"},{"location":"architecture/security/#cloud-functions-sikkerhet","title":"Cloud Functions sikkerhet","text":""},{"location":"architecture/security/#validering-i-functions","title":"Validering i Functions","text":"<p>Alle callable functions m\u00e5 validere tilgang:</p> <pre><code>// functions/src/rentals.ts\nexport const createRental = onCall(async (data, context) =&gt; {\n  // 1. Sjekk autentisering\n  if (!context.auth) {\n    throw new HttpsError('unauthenticated', 'Ikke innlogget');\n  }\n\n  // 2. Sjekk rolle\n  const role = context.auth.token.role as string;\n  if (!['superadmin', 'clubAdmin', 'staff'].includes(role)) {\n    throw new HttpsError('permission-denied', 'Mangler tilgang');\n  }\n\n  // 3. Sjekk clubId matching\n  const { clubId } = data;\n  const userClubs = context.auth.token.clubs as string[];\n\n  if (!userClubs.includes(clubId)) {\n    throw new HttpsError('permission-denied', 'Ikke tilgang til denne klubben');\n  }\n\n  // 4. Valider input\n  const { cartId, renterName, holes } = data;\n  if (!cartId || !renterName || ![9, 18].includes(holes)) {\n    throw new HttpsError('invalid-argument', 'Ugyldig data');\n  }\n\n  // 5. Utf\u00f8r operasjon med Admin SDK (bypasser security rules)\n  const db = admin.firestore();\n  // ... resten av logikken\n});\n</code></pre>"},{"location":"architecture/security/#rate-limiting","title":"Rate limiting","text":"<p>Bruk Firebase App Check og Cloud Armor:</p> <pre><code>// functions/src/index.ts\nimport { onCall } from 'firebase-functions/v2/https';\n\nexport const createRental = onCall(\n  {\n    enforceAppCheck: true,  // Krever gyldig App Check token\n    consumeAppCheckToken: true,\n    cors: ['https://golfchart.app']\n  },\n  async (data, context) =&gt; {\n    // Handler her\n  }\n);\n</code></pre>"},{"location":"architecture/security/#secrets-management","title":"Secrets management","text":"<p>Aldri hardkod API-n\u00f8kler i kode. Bruk Firebase Secret Manager:</p> <pre><code># Sett secrets\nfirebase functions:secrets:set SENDGRID_API_KEY\nfirebase functions:secrets:set TWILIO_AUTH_TOKEN\nfirebase functions:secrets:set GEMINI_API_KEY\n</code></pre> <p>Bruk i functions:</p> <pre><code>// functions/src/notifications.ts\nimport { defineSecret } from 'firebase-functions/params';\n\nconst sendgridKey = defineSecret('SENDGRID_API_KEY');\n\nexport const sendEmail = onCall(\n  { secrets: [sendgridKey] },\n  async (data, context) =&gt; {\n    const apiKey = sendgridKey.value();\n    // Bruk apiKey\n  }\n);\n</code></pre>"},{"location":"architecture/security/#cors-og-csp","title":"CORS og CSP","text":""},{"location":"architecture/security/#firebase-hosting-headers","title":"Firebase Hosting headers","text":"<pre><code>// firebase.json\n{\n  \"hosting\": {\n    \"public\": \"admin/dist\",\n    \"headers\": [\n      {\n        \"source\": \"**\",\n        \"headers\": [\n          {\n            \"key\": \"Content-Security-Policy\",\n            \"value\": \"default-src 'self'; script-src 'self' https://apis.google.com; style-src 'self' 'unsafe-inline'; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com\"\n          },\n          {\n            \"key\": \"X-Content-Type-Options\",\n            \"value\": \"nosniff\"\n          },\n          {\n            \"key\": \"X-Frame-Options\",\n            \"value\": \"DENY\"\n          }\n        ]\n      }\n    ]\n  }\n}\n</code></pre>"},{"location":"architecture/security/#logging-og-monitoring","title":"Logging og monitoring","text":""},{"location":"architecture/security/#frontend-feilrapportering","title":"Frontend feilrapportering","text":"<p>Bruk Sentry eller Firebase Crashlytics:</p> <pre><code>// admin/src/main.tsx\nimport * as Sentry from '@sentry/react';\n\nSentry.init({\n  dsn: import.meta.env.VITE_SENTRY_DSN,\n  environment: import.meta.env.MODE,\n  integrations: [\n    Sentry.browserTracingIntegration(),\n    Sentry.replayIntegration()\n  ],\n  tracesSampleRate: 1.0,\n  replaysSessionSampleRate: 0.1\n});\n</code></pre>"},{"location":"architecture/security/#cloud-functions-logging","title":"Cloud Functions logging","text":"<pre><code>import { logger } from 'firebase-functions/v2';\n\nexport const createRental = onCall(async (data, context) =&gt; {\n  logger.info('createRental called', {\n    uid: context.auth?.uid,\n    clubId: data.clubId,\n    cartId: data.cartId\n  });\n\n  try {\n    // ... operasjon\n    logger.info('Rental created successfully', { rentalId });\n  } catch (error) {\n    logger.error('Failed to create rental', error);\n    throw new HttpsError('internal', 'Noe gikk galt');\n  }\n});\n</code></pre>"},{"location":"architecture/security/#security-checklist","title":"Security checklist","text":"<ul> <li>[ ] Firestore Security Rules er deployet og testet</li> <li>[ ] Custom Claims er konfigurert for alle brukere</li> <li>[ ] Cloud Functions validerer auth og clubId i hver request</li> <li>[ ] Secrets er lagret i Secret Manager (ikke i kode)</li> <li>[ ] CORS er konfigurert riktig i firebase.json</li> <li>[ ] CSP headers er satt for hosting</li> <li>[ ] Rate limiting er aktivert (App Check)</li> <li>[ ] Logging og monitoring er satt opp</li> <li>[ ] Security review er gjennomf\u00f8rt f\u00f8r produksjon</li> </ul>"},{"location":"architecture/security/#neste-steg","title":"Neste steg","text":"<ul> <li>Multi-tenancy design \u2014 ClubId-isolasjon i praksis</li> <li>API dokumentasjon \u2014 Auth endpoints og flows</li> <li>Deployment guide \u2014 Sikker produksjons-deployment</li> </ul>"},{"location":"architecture/system/","title":"Systemarkitektur","text":"<p>GolfChart er bygget med Firebase som backend og moderne React frontend, designet for multi-klubb bruk med sterk dataisolasjon.</p>"},{"location":"architecture/system/#overordnet-arkitektur","title":"Overordnet arkitektur","text":"<pre><code>graph TB\n    subgraph \"Frontend\"\n        A[Admin UI&lt;br/&gt;React + Vite]\n        B[Public UI&lt;br/&gt;React + Gemini AI]\n    end\n\n    subgraph \"Firebase\"\n        C[Firebase Auth]\n        D[Firestore]\n        E[Cloud Functions]\n        F[Cloud Storage]\n        G[Firebase Hosting]\n    end\n\n    subgraph \"Eksterne tjenester\"\n        H[SendGrid&lt;br/&gt;Email]\n        I[Twilio&lt;br/&gt;SMS]\n        J[Google Gemini AI]\n    end\n\n    A --&gt; C\n    A --&gt; D\n    B --&gt; J\n    E --&gt; D\n    E --&gt; H\n    E --&gt; I\n    A --&gt; G\n    B --&gt; G\n    E --&gt; F\n\n    style A fill:#4285f4,stroke:#1967d2,color:#fff\n    style B fill:#34a853,stroke:#188038,color:#fff\n    style D fill:#fbbc04,stroke:#f29900,color:#000\n    style E fill:#ea4335,stroke:#c5221f,color:#fff</code></pre>"},{"location":"architecture/system/#arkitektoniske-beslutninger","title":"Arkitektoniske beslutninger","text":""},{"location":"architecture/system/#1-multi-tenancy-modell","title":"1. Multi-tenancy modell","text":"<p>Beslutning: Shared database med clubId-basert isolasjon</p> <p>Rationale:</p> <ul> <li>Enklere vedlikehold enn separate Firebase-prosjekter per klubb</li> <li>Kostnadseffektivt for sm\u00e5 klubber</li> <li>Sentralisert overv\u00e5kning og backup</li> </ul> <p>Implikasjoner:</p> <ul> <li>Security rules m\u00e5 strengt h\u00e5ndheve clubId-filtrering</li> <li>Alle queries m\u00e5 inkludere clubId</li> <li>Custom claims brukes for rollebasert tilgang</li> </ul>"},{"location":"architecture/system/#2-frontend-separasjon","title":"2. Frontend separasjon","text":"<p>Beslutning: To separate React-apper (Admin vs Public)</p> <p>Rationale:</p> <ul> <li>Admin UI krever autentisering og kompleks state management</li> <li>Public UI er enkel, fokusert p\u00e5 AI-assistenten \"Golfy\"</li> <li>Muliggj\u00f8r uavhengige deploy-cycles</li> </ul> <p>Deployment:</p> <pre><code>firebase.json:\n  hosting:\n    - public: admin/dist     # Admin UI p\u00e5 /admin\n    - public: public/dist    # Public UI p\u00e5 /\n</code></pre>"},{"location":"architecture/system/#3-cloud-functions-role","title":"3. Cloud Functions role","text":"<p>Beslutning: Minimal server-side logic, mest i frontend</p> <p>Rationale:</p> <ul> <li>Reduserer cold-start latens</li> <li>Enklere debugging i browser</li> <li>Functions reservert for:</li> <li>Sensitivt prisberegning</li> <li>Notifikasjonsutsending</li> <li>Batch jobs (rapporter)</li> </ul> <p>Kritiske Functions:</p> <pre><code>// functions/src/index.ts\nexports.createRental = onCall(async (data, context) =&gt; {\n  // Validering av clubId tilgang\n  // Transaksjon: cart + rental + price calculation\n});\n\nexports.sendNotification = onCall(async (data, context) =&gt; {\n  // SendGrid/Twilio integration\n});\n\nexports.generateReport = onSchedule('0 2 * * 1', async (context) =&gt; {\n  // Ukentlige rapporter til Storage\n});\n</code></pre>"},{"location":"architecture/system/#4-auth-strategi","title":"4. Auth strategi","text":"<p>Beslutning: Firebase Auth med custom claims for roller</p> <p>Roller:</p> <pre><code>interface CustomClaims {\n  role: 'superadmin' | 'clubAdmin' | 'staff' | 'viewer';\n  clubs: string[];  // Liste av clubIds brukeren har tilgang til\n}\n</code></pre> <p>Flow:</p> <pre><code>sequenceDiagram\n    participant U as Bruker\n    participant A as Admin UI\n    participant Auth as Firebase Auth\n    participant F as Cloud Function\n    participant FS as Firestore\n\n    U-&gt;&gt;A: Login\n    A-&gt;&gt;Auth: signInWithEmailAndPassword\n    Auth--&gt;&gt;A: ID Token + Custom Claims\n    A-&gt;&gt;F: createRental(data)\n    F-&gt;&gt;Auth: Verify token &amp; claims\n    F-&gt;&gt;FS: Write hvis clubId matcher\n    FS--&gt;&gt;F: OK\n    F--&gt;&gt;A: Success\n    A--&gt;&gt;U: Vis bekreftelse</code></pre>"},{"location":"architecture/system/#5-real-time-vs-batch","title":"5. Real-time vs Batch","text":"<p>Beslutning: Real-time for cart status, batch for rapporter</p> <p>Real-time (Firestore listeners):</p> <ul> <li>Cart availability i Admin UI</li> <li>Aktive rentals</li> <li>Maintenancelogger</li> </ul> <p>Batch (Scheduled Functions):</p> <ul> <li>Daglige inntektsrapporter</li> <li>Ukentlige CSVer</li> <li>M\u00e5nedlige statistikk-e-poster</li> </ul>"},{"location":"architecture/system/#dataflyt","title":"Dataflyt","text":""},{"location":"architecture/system/#utleie-flow","title":"Utleie-flow","text":"<pre><code>sequenceDiagram\n    participant Staff as Staff (Admin UI)\n    participant CF as Cloud Function\n    participant FS as Firestore\n    participant Email as SendGrid\n\n    Staff-&gt;&gt;CF: createRental({cartId, renterName, ...})\n    CF-&gt;&gt;FS: Transaksjon START\n    CF-&gt;&gt;FS: Les cart (sjekk available)\n    CF-&gt;&gt;FS: Les pricingRules\n    CF-&gt;&gt;CF: Beregn pris\n    CF-&gt;&gt;FS: Opprett rental\n    CF-&gt;&gt;FS: Oppdater cart.status = 'rented'\n    CF-&gt;&gt;FS: Transaksjon COMMIT\n    CF-&gt;&gt;Email: Send notifikasjon (async)\n    CF--&gt;&gt;Staff: { rentalId, price }\n    Staff-&gt;&gt;Staff: Vis kvittering</code></pre>"},{"location":"architecture/system/#innlevering-flow","title":"Innlevering-flow","text":"<pre><code>sequenceDiagram\n    participant Staff as Staff (Admin UI)\n    participant CF as Cloud Function\n    participant FS as Firestore\n\n    Staff-&gt;&gt;CF: endRental({rentalId})\n    CF-&gt;&gt;FS: Transaksjon START\n    CF-&gt;&gt;FS: Les rental\n    CF-&gt;&gt;FS: Sett rental.endTime\n    CF-&gt;&gt;FS: Les cart\n    CF-&gt;&gt;FS: Oppdater cart.status = 'available'\n    CF-&gt;&gt;FS: Transaksjon COMMIT\n    CF--&gt;&gt;Staff: { rental, duration }\n    Staff-&gt;&gt;Staff: Vis oppsummering</code></pre>"},{"location":"architecture/system/#feilhandtering","title":"Feilh\u00e5ndtering","text":""},{"location":"architecture/system/#retry-strategi","title":"Retry-strategi","text":"<p>Cloud Functions:</p> <pre><code>// functions/src/utils/retry.ts\nexport async function retryOperation&lt;T&gt;(\n  operation: () =&gt; Promise&lt;T&gt;,\n  maxRetries = 3,\n  delayMs = 1000\n): Promise&lt;T&gt; {\n  for (let i = 0; i &lt; maxRetries; i++) {\n    try {\n      return await operation();\n    } catch (error) {\n      if (i === maxRetries - 1) throw error;\n      await new Promise(resolve =&gt; setTimeout(resolve, delayMs * (i + 1)));\n    }\n  }\n  throw new Error('Max retries reached');\n}\n</code></pre> <p>Frontend:</p> <pre><code>// admin/src/hooks/useFirestore.ts\nconst { data, error, retry } = useFirestoreQuery({\n  collection: 'rentals',\n  where: [['clubId', '==', currentClub]],\n  orderBy: [['startTime', 'desc']],\n  limit: 50,\n  retryOnError: true,\n  retryCount: 3\n});\n</code></pre>"},{"location":"architecture/system/#offline-handtering","title":"Offline-h\u00e5ndtering","text":"<p>Firebase Firestore SDK har innebygd offline-st\u00f8tte:</p> <pre><code>// admin/src/firebase.ts\nconst db = getFirestore(app);\nenableMultiTabIndexedDbPersistence(db).catch((err) =&gt; {\n  if (err.code === 'failed-precondition') {\n    console.warn('Persistence ikke tilgjengelig i flere tabs');\n  } else if (err.code === 'unimplemented') {\n    console.warn('Browser st\u00f8tter ikke persistence');\n  }\n});\n</code></pre>"},{"location":"architecture/system/#skaleringsplan","title":"Skaleringsplan","text":""},{"location":"architecture/system/#fase-1-mvp-1-5-klubber","title":"Fase 1 (MVP): 1-5 klubber","text":"<ul> <li>Single Firebase project</li> <li>europe-west1 region</li> <li>Standard pricing</li> </ul>"},{"location":"architecture/system/#fase-2-5-20-klubber","title":"Fase 2: 5-20 klubber","text":"<ul> <li>Sharding vurderes (men trolig ikke n\u00f8dvendig)</li> <li>Oppgrader til Blaze plan for bedre support</li> <li>CDN for statiske assets</li> </ul>"},{"location":"architecture/system/#fase-3-20-klubber","title":"Fase 3: 20+ klubber","text":"<ul> <li>Multi-region deployment vurderes</li> <li>Dedikerte Cloud Functions per klubb-group</li> <li>Analytics og monitoring med Datadog/New Relic</li> </ul>"},{"location":"architecture/system/#sikkerhet","title":"Sikkerhet","text":"<p>Se Sikkerhetsmodell for detaljer om:</p> <ul> <li>Firestore Security Rules</li> <li>Custom Claims validering</li> <li>CORS-konfigur asjon</li> <li>Secrets management</li> </ul>"},{"location":"architecture/system/#neste-steg","title":"Neste steg","text":"<ul> <li>Datamodell \u2014 Firestore kolleksjoner og struktur</li> <li>Multi-tenancy \u2014 ClubId-isolasjon i praksis</li> <li>API dokumentasjon \u2014 Cloud Functions og endpoints</li> </ul>"},{"location":"getting-started/firebase-setup/","title":"Firebase oppsett","text":"<p>Denne guiden viser hvordan du setter opp Firebase-prosjektet for GolfChart.</p>"},{"location":"getting-started/firebase-setup/#forutsetninger","title":"Forutsetninger","text":"<ul> <li>Node.js 18+ installert</li> <li>Firebase CLI installert globalt</li> <li>Tilgang til Firebase-prosjektet</li> </ul>"},{"location":"getting-started/firebase-setup/#installasjon","title":"Installasjon","text":""},{"location":"getting-started/firebase-setup/#1-installer-firebase-cli","title":"1. Installer Firebase CLI","text":"<pre><code>npm install -g firebase-tools\n</code></pre>"},{"location":"getting-started/firebase-setup/#2-logg-inn-pa-firebase","title":"2. Logg inn p\u00e5 Firebase","text":"<pre><code>firebase login\n</code></pre>"},{"location":"getting-started/firebase-setup/#3-velg-prosjekt","title":"3. Velg prosjekt","text":"<pre><code># Sjekk tilgjengelige prosjekter\nfirebase projects:list\n\n# Velg aktivt prosjekt (dev/stage/prod)\nfirebase use dev\n</code></pre>"},{"location":"getting-started/firebase-setup/#prosjekter-og-miljer","title":"Prosjekter og milj\u00f8er","text":"<p>GolfChart bruker tre separate Firebase-prosjekter:</p> Milj\u00f8 Prosjekt-ID Form\u00e5l dev <code>golfbilkontroll-skigk-dev</code> Lokal utvikling og testing stage <code>golfbilkontroll-skigk-stage</code> Staging/QA f\u00f8r produksjon prod <code>golfbilkontroll-skigk</code> Produksjonsmilj\u00f8"},{"location":"getting-started/firebase-setup/#sette-opp-aliaser","title":"Sette opp aliaser","text":"<pre><code>firebase use --add\n# Velg dev-prosjekt, gi alias: dev\n# Gjenta for stage og prod\n</code></pre>"},{"location":"getting-started/firebase-setup/#aktivere-firebase-tjenester","title":"Aktivere Firebase-tjenester","text":""},{"location":"getting-started/firebase-setup/#1-firestore-database","title":"1. Firestore Database","text":"<pre><code># Region: europe-west1 (anbefalt for Norge)\nfirebase firestore:databases:create (default) --location=europe-west1\n</code></pre>"},{"location":"getting-started/firebase-setup/#2-authentication","title":"2. Authentication","text":"<p>I Firebase Console: 1. G\u00e5 til Authentication &gt; Sign-in method 2. Aktiver \"Email/Password\" 3. (Valgfritt) Aktiver \"Google\" for OAuth</p>"},{"location":"getting-started/firebase-setup/#3-storage","title":"3. Storage","text":"<pre><code>firebase storage:buckets:create gs://golfbilkontroll-skigk.appspot.com --location=europe-west1\n</code></pre>"},{"location":"getting-started/firebase-setup/#4-hosting","title":"4. Hosting","text":"<p>Allerede konfigurert i <code>firebase.json</code>:</p> <pre><code>{\n  \"hosting\": {\n    \"site\": \"golfbilkontroll-skigk\",\n    \"public\": \"admin/dist\"\n  }\n}\n</code></pre>"},{"location":"getting-started/firebase-setup/#konfigurere-secrets","title":"Konfigurere secrets","text":"<p>Sensitive API-n\u00f8kler lagres med Firebase Functions config:</p> <pre><code># SendGrid (e-post)\nfirebase functions:config:set sendgrid.key=\"SG.xxxxx\"\n\n# Twilio (SMS)\nfirebase functions:config:set twilio.sid=\"ACxxxxx\" twilio.token=\"xxxxx\"\n\n# Gemini AI\nfirebase functions:config:set ai.gemini_api_key=\"AIzaSyxxxxx\"\n</code></pre> <p>Sjekk konfigurasjon:</p> <pre><code>firebase functions:config:get\n</code></pre>"},{"location":"getting-started/firebase-setup/#deploy-frste-gang","title":"Deploy f\u00f8rste gang","text":"<pre><code># Bygg admin UI\ncd admin\nnpm run build\ncd ..\n\n# Deploy alt\nfirebase deploy\n</code></pre>"},{"location":"getting-started/firebase-setup/#delvis-deploy","title":"Delvis deploy","text":"<pre><code># Kun sikkerhetsregler\nfirebase deploy --only firestore:rules\n\n# Kun functions\nfirebase deploy --only functions\n\n# Kun hosting\nfirebase deploy --only hosting\n</code></pre>"},{"location":"getting-started/firebase-setup/#lokal-emulering","title":"Lokal emulering","text":"<p>For utvikling uten \u00e5 p\u00e5virke prod-data:</p> <pre><code># Start emulatorer\nfirebase emulators:start\n\n# Med spesifikke tjenester\nfirebase emulators:start --only firestore,functions,auth\n</code></pre> <p>Tilgjengelig p\u00e5: - Firestore: <code>localhost:8080</code> - Functions: <code>localhost:5001</code> - Auth: <code>localhost:9099</code> - Hosting: <code>localhost:5000</code> - UI: <code>localhost:4000</code></p>"},{"location":"getting-started/firebase-setup/#verifisering","title":"Verifisering","text":"<p>Test at alt fungerer:</p> <pre><code># Sjekk Firestore-regler\nfirebase firestore:rules:get\n\n# List deployede funksjoner\nfirebase functions:list\n\n# Sjekk hosting URL\nfirebase hosting:sites:list\n</code></pre>"},{"location":"getting-started/firebase-setup/#feilsking","title":"Feils\u00f8king","text":""},{"location":"getting-started/firebase-setup/#permissions-feil","title":"Permissions-feil","text":"<p>Sjekk at du har riktige roller i Firebase Console: - Owner eller Editor for full tilgang - Firebase Admin for deployment</p>"},{"location":"getting-started/firebase-setup/#region-problemer","title":"Region-problemer","text":"<p>S\u00f8rg for konsistent region (<code>europe-west1</code>) p\u00e5 tvers av: - Firestore location - Functions region (i <code>functions/src/index.ts</code>) - Storage bucket</p>"},{"location":"getting-started/firebase-setup/#config-ikke-tilgjengelig-i-functions","title":"Config ikke tilgjengelig i functions","text":"<pre><code># Hent lokal config for emulator\nfirebase functions:config:get &gt; functions/.runtimeconfig.json\n</code></pre>"},{"location":"getting-started/firebase-setup/#neste-steg","title":"Neste steg","text":"<ul> <li>Lokal utvikling \u2014 Sett opp development-milj\u00f8</li> <li>Security Rules \u2014 Forst\u00e5 sikkerhetsmodellen</li> <li>Cloud Functions \u2014 Backend API-dokumentasjon</li> </ul>"},{"location":"getting-started/local-dev/","title":"Lokal utviklingsmilj\u00f8","text":"<p>Denne guiden viser hvordan du setter opp et komplett lokalt utviklingsmilj\u00f8 for GolfChart med Firebase Emulator Suite.</p>"},{"location":"getting-started/local-dev/#forutsetninger","title":"Forutsetninger","text":"<ul> <li>Node.js: 18 eller nyere (last ned)</li> <li>pnpm: Foretrukket package manager (installer)</li> <li>Firebase CLI: Installert globalt (se Firebase Setup)</li> <li>Java: JDK 11+ for Firestore emulator (AdoptOpenJDK)</li> <li>Git: For versjonskontroll</li> </ul>"},{"location":"getting-started/local-dev/#prosjektstruktur","title":"Prosjektstruktur","text":"<pre><code>GolfChartAppV0.9/\n\u251c\u2500\u2500 admin/                  # Admin UI (React + Vite)\n\u2502   \u251c\u2500\u2500 src/\n\u2502   \u251c\u2500\u2500 package.json\n\u2502   \u2514\u2500\u2500 vite.config.ts\n\u251c\u2500\u2500 functions/              # Cloud Functions (Node + TypeScript)\n\u2502   \u251c\u2500\u2500 src/\n\u2502   \u251c\u2500\u2500 package.json\n\u2502   \u2514\u2500\u2500 tsconfig.json\n\u251c\u2500\u2500 public/                 # Public UI (eksisterende app)\n\u251c\u2500\u2500 docs/                   # MkDocs dokumentasjon\n\u251c\u2500\u2500 firebase.json           # Firebase config\n\u251c\u2500\u2500 firestore.rules         # Security rules\n\u251c\u2500\u2500 firestore.indexes.json  # Firestore indekser\n\u2514\u2500\u2500 mkdocs.yml              # Dokumentasjon config\n</code></pre>"},{"location":"getting-started/local-dev/#installasjon","title":"Installasjon","text":""},{"location":"getting-started/local-dev/#1-klon-repository","title":"1. Klon repository","text":"<pre><code>git clone https://github.com/yourusername/golfchart.git\ncd golfchart\n</code></pre>"},{"location":"getting-started/local-dev/#2-installer-dependencies","title":"2. Installer dependencies","text":"<p>Root og Functions:</p> <pre><code># Installer Firebase Functions dependencies\ncd functions\npnpm install\ncd ..\n</code></pre> <p>Admin UI:</p> <pre><code>cd admin\npnpm install\ncd ..\n</code></pre>"},{"location":"getting-started/local-dev/#3-konfigurer-miljvariabler","title":"3. Konfigurer milj\u00f8variabler","text":"<p>Admin UI (.env.local):</p> <pre><code># admin/.env.local\nVITE_FIREBASE_API_KEY=din-api-key\nVITE_FIREBASE_AUTH_DOMAIN=golfbilkontroll-skigk.firebaseapp.com\nVITE_FIREBASE_PROJECT_ID=golfbilkontroll-skigk\nVITE_FIREBASE_STORAGE_BUCKET=golfbilkontroll-skigk.appspot.com\nVITE_FIREBASE_MESSAGING_SENDER_ID=123456789\nVITE_FIREBASE_APP_ID=1:123456789:web:abc123\nVITE_USE_EMULATOR=true\n</code></pre> <p>Functions (.env):</p> <pre><code># functions/.env\nSENDGRID_API_KEY=test-key-for-local\nTWILIO_AUTH_TOKEN=test-token-for-local\nGEMINI_API_KEY=test-gemini-key\n</code></pre> <p>Tips: For lokal utvikling kan du bruke dummy-verdier for eksterne API-n\u00f8kler.</p>"},{"location":"getting-started/local-dev/#firebase-emulator-suite","title":"Firebase Emulator Suite","text":""},{"location":"getting-started/local-dev/#starte-emulatorer","title":"Starte emulatorer","text":"<pre><code>firebase emulators:start\n</code></pre> <p>Dette starter:</p> <ul> <li>\ud83d\udd25 Firestore p\u00e5 <code>localhost:8080</code></li> <li>\ud83d\udd10 Auth p\u00e5 <code>localhost:9099</code></li> <li>\u26a1 Functions p\u00e5 <code>localhost:5001</code></li> <li>\ud83d\udce6 Storage p\u00e5 <code>localhost:9199</code></li> <li>\ud83c\udf9b\ufe0f Emulator UI p\u00e5 <code>localhost:4000</code></li> </ul>"},{"location":"getting-started/local-dev/#emulator-ui","title":"Emulator UI","text":"<p>\u00c5pne http://localhost:4000 for \u00e5:</p> <ul> <li>Se Firestore data</li> <li>Administrere Auth brukere</li> <li>Inspisere Function logs</li> <li>Teste Storage filer</li> </ul>"},{"location":"getting-started/local-dev/#importere-testdata","title":"Importere testdata","text":"<p>Opprett seed-data for utvikling:</p> <pre><code># functions/src/seed.ts\nimport * as admin from 'firebase-admin';\n\nadmin.initializeApp();\nconst db = admin.firestore();\n\nasync function seed() {\n  // Opprett testklubb\n  await db.doc('clubs/ski-gk').set({\n    name: 'Ski Golfklubb',\n    slug: 'ski-gk',\n    active: true,\n    contact: {\n      email: 'test@skigk.no',\n      phone: '+47 12345678'\n    },\n    timezone: 'Europe/Oslo',\n    createdAt: admin.firestore.FieldValue.serverTimestamp(),\n    updatedAt: admin.firestore.FieldValue.serverTimestamp()\n  });\n\n  // Opprett prisregler\n  await db.collection('pricingRules').add({\n    clubId: 'ski-gk',\n    holes18: { member: 350, nonMember: 425 },\n    holes9: { member: 200, nonMember: 250 },\n    doctorsNoteDiscount: 50,\n    effectiveFrom: admin.firestore.Timestamp.now(),\n    effectiveTo: null\n  });\n\n  // Opprett 3 carts\n  for (let i = 1; i &lt;= 3; i++) {\n    await db.collection('carts').add({\n      clubId: 'ski-gk',\n      status: 'available',\n      label: `Bil ${i}`,\n      serial: `GOLF-2023-00${i}`,\n      notes: '',\n      currentRentalId: null,\n      createdAt: admin.firestore.FieldValue.serverTimestamp(),\n      updatedAt: admin.firestore.FieldValue.serverTimestamp()\n    });\n  }\n\n  console.log('\u2705 Seed data created');\n}\n\nseed().catch(console.error);\n</code></pre> <p>Kj\u00f8r seeding:</p> <pre><code>cd functions\nnpx ts-node src/seed.ts\n</code></pre>"},{"location":"getting-started/local-dev/#utviklingsworkflow","title":"Utviklingsworkflow","text":""},{"location":"getting-started/local-dev/#1-start-alle-tjenester","title":"1. Start alle tjenester","text":"<p>Terminal 1 (Emulatorer):</p> <pre><code>firebase emulators:start\n</code></pre> <p>Terminal 2 (Admin UI dev server):</p> <pre><code>cd admin\npnpm dev\n</code></pre> <p>Admin UI er n\u00e5 tilgjengelig p\u00e5 http://localhost:5173</p> <p>Terminal 3 (Functions watch - valgfritt):</p> <pre><code>cd functions\npnpm build --watch\n</code></pre>"},{"location":"getting-started/local-dev/#2-administrere-testbrukere","title":"2. Administrere testbrukere","text":"<p>Opprett en testbruker via Emulator UI eller via Firebase CLI:</p> <pre><code>firebase auth:import users.json --project golfbilkontroll-skigk\n</code></pre> <p>users.json:</p> <pre><code>{\n  \"users\": [\n    {\n      \"localId\": \"test-admin-123\",\n      \"email\": \"admin@skigk.no\",\n      \"passwordHash\": \"...\",\n      \"displayName\": \"Test Admin\",\n      \"customClaims\": \"{\\\"role\\\":\\\"clubAdmin\\\",\\\"clubs\\\":[\\\"ski-gk\\\"]}\"\n    }\n  ]\n}\n</code></pre> <p>Eller opprett manuelt i Emulator UI (http://localhost:4000/auth) med en enkel passord-autentisering.</p>"},{"location":"getting-started/local-dev/#3-hot-reload","title":"3. Hot reload","text":"<ul> <li>Admin UI: Vite hot-reloader ved filendringer</li> <li>Functions: Emulator restarter automatisk ved endringer i build-output</li> <li>Firestore Rules: Deploy med <code>firebase deploy --only firestore:rules</code></li> </ul>"},{"location":"getting-started/local-dev/#4-debugging","title":"4. Debugging","text":"<p>Frontend (Chrome DevTools):</p> <pre><code>// admin/src/firebase.ts\nimport { connectFirestoreEmulator } from 'firebase/firestore';\nimport { connectAuthEmulator } from 'firebase/auth';\n\nif (import.meta.env.VITE_USE_EMULATOR === 'true') {\n  connectFirestoreEmulator(db, 'localhost', 8080);\n  connectAuthEmulator(auth, 'http://localhost:9099');\n  console.log('\ud83d\udd27 Using Firebase Emulators');\n}\n</code></pre> <p>Functions (VS Code debugger):</p> <p><code>.vscode/launch.json</code>:</p> <pre><code>{\n  \"version\": \"0.2.0\",\n  \"configurations\": [\n    {\n      \"type\": \"node\",\n      \"request\": \"attach\",\n      \"name\": \"Attach to Functions\",\n      \"port\": 9229,\n      \"restart\": true,\n      \"sourceMaps\": true,\n      \"outFiles\": [\"${workspaceFolder}/functions/lib/**/*.js\"]\n    }\n  ]\n}\n</code></pre> <p>Start emulators med inspect:</p> <pre><code>firebase emulators:start --inspect-functions\n</code></pre>"},{"location":"getting-started/local-dev/#testing","title":"Testing","text":""},{"location":"getting-started/local-dev/#unit-tests-admin-ui","title":"Unit tests (Admin UI)","text":"<pre><code>cd admin\npnpm test\n</code></pre> <p>Eksempel test:</p> <pre><code>// admin/src/components/__tests__/CartCard.test.tsx\nimport { render, screen } from '@testing-library/react';\nimport { CartCard } from '../CartCard';\n\ntest('viser cart status', () =&gt; {\n  render(&lt;CartCard cart={{ label: 'Bil 1', status: 'available' }} /&gt;);\n  expect(screen.getByText('Bil 1')).toBeInTheDocument();\n  expect(screen.getByText('Tilgjengelig')).toBeInTheDocument();\n});\n</code></pre>"},{"location":"getting-started/local-dev/#security-rules-tests","title":"Security Rules tests","text":"<pre><code>cd functions\npnpm test:rules\n</code></pre> <p>Eksempel test:</p> <pre><code>// tests/firestore-rules.test.ts\nimport { assertFails, assertSucceeds } from '@firebase/rules-unit-testing';\n\ntest('klubbadmin kan lese egne klubber', async () =&gt; {\n  const db = testEnv.authenticatedContext('user123', {\n    role: 'clubAdmin',\n    clubs: ['ski-gk']\n  }).firestore();\n\n  await assertSucceeds(\n    db.collection('rentals').where('clubId', '==', 'ski-gk').get()\n  );\n});\n</code></pre>"},{"location":"getting-started/local-dev/#integration-tests-functions","title":"Integration tests (Functions)","text":"<pre><code>cd functions\npnpm test:integration\n</code></pre>"},{"location":"getting-started/local-dev/#dokumentasjon-mkdocs","title":"Dokumentasjon (MkDocs)","text":""},{"location":"getting-started/local-dev/#installere-mkdocs","title":"Installere MkDocs","text":"<pre><code>pip install mkdocs-material mkdocs-git-revision-date-localized-plugin\n</code></pre>"},{"location":"getting-started/local-dev/#kjre-docs-lokalt","title":"Kj\u00f8re docs lokalt","text":"<pre><code>mkdocs serve\n</code></pre> <p>Dokumentasjon er tilgjengelig p\u00e5 http://localhost:8000</p>"},{"location":"getting-started/local-dev/#bygge-docs","title":"Bygge docs","text":"<pre><code>mkdocs build\n</code></pre> <p>Genererer statiske filer i <code>site/</code> som kan deployes til GitHub Pages eller Firebase Hosting.</p>"},{"location":"getting-started/local-dev/#feilsking","title":"Feils\u00f8king","text":""},{"location":"getting-started/local-dev/#problem-firestore-emulator-starter-ikke","title":"Problem: Firestore emulator starter ikke","text":"<p>L\u00f8sning: Sjekk at port 8080 ikke er i bruk:</p> <pre><code>netstat -ano | findstr :8080\n</code></pre> <p>Kill prosess eller endre port i <code>firebase.json</code>:</p> <pre><code>{\n  \"emulators\": {\n    \"firestore\": {\n      \"port\": 8081\n    }\n  }\n}\n</code></pre>"},{"location":"getting-started/local-dev/#problem-auth-emulator-har-ingen-brukere","title":"Problem: Auth emulator har ingen brukere","text":"<p>L\u00f8sning: Opprett manuelt i Emulator UI (http://localhost:4000/auth) eller importer <code>users.json</code>.</p>"},{"location":"getting-started/local-dev/#problem-functions-kan-ikke-na-firestore","title":"Problem: Functions kan ikke n\u00e5 Firestore","text":"<p>L\u00f8sning: S\u00f8rg for at Functions bruker emulator:</p> <pre><code>// functions/src/index.ts (for testing)\nif (process.env.FUNCTIONS_EMULATOR) {\n  process.env.FIRESTORE_EMULATOR_HOST = 'localhost:8080';\n}\n</code></pre>"},{"location":"getting-started/local-dev/#problem-cors-feil-i-admin-ui","title":"Problem: CORS-feil i Admin UI","text":"<p>L\u00f8sning: Legg til CORS i Functions:</p> <pre><code>// functions/src/index.ts\nimport { onCall } from 'firebase-functions/v2/https';\n\nexport const myFunction = onCall(\n  { cors: ['http://localhost:5173'] },\n  async (data, context) =&gt; {\n    // ...\n  }\n);\n</code></pre>"},{"location":"getting-started/local-dev/#neste-steg","title":"Neste steg","text":"<ul> <li>Firebase Setup \u2014 Deploy til produksjon</li> <li>Admin UI oversikt \u2014 Utvikle UI-komponenter</li> <li>API dokumentasjon \u2014 Cloud Functions referanse</li> <li>Testing guide \u2014 Skriv gode tester</li> </ul>"}]}